version: '3.7'

services:
  main:
    container_name: ${APP_NAME}
    build:
        context: .
        dockerfile: docker/cr.dockerfile
        target: development
    volumes:
        - .:/usr/src/app
        - /usr/src/app/node_modules
    ports:
        - '${APP_PORT}:${APP_PORT}'
        - '${DEBUG_PORT}:${DEBUG_PORT}'
    command: npm run start:debug
    env_file:
        - .env
    networks:
        - cr-network
    depends_on:
        - postgis

  postgis:
    container_name: postgis
    image: mdillon/postgis
    volumes:
        - postgis-data:/var/lib/postgresql/data
    environment:
        POSTGRES_DB: ${POSTGRES_DB}
        POSTGRES_USER: ${POSTGRES_USER}
        POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
        PG_DATA: /var/lib/postgresql/data
    ports:
        - "${POSTGRES_HOST_PORT}:5432"
    restart: on-failure
    networks:
        - cr-network

  pgadmin:
    container_name: pgadmin
    image: dpage/pgadmin4
    depends_on:
        - postgis
    environment:
        PGADMIN_DEFAULT_EMAIL: ${PGADMIN_EMAIL}
        PGADMIN_DEFAULT_PASSWORD: ${PGADMIN_PASSWORD}
    volumes:
        - pgadmin:/root/.pgadmin
    ports:
        - "${PGADMIN_PORT}:80"
    networks:
        - cr-network

volumes:
    postgis-data:
        driver: local
    pgadmin:
        driver: local

networks:
    cr-network:
        driver: bridge